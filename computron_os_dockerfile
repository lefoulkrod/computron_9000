FROM ubuntu:22.04

# Non-interactive + UTC timezone
ENV DEBIAN_FRONTEND=noninteractive
RUN ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime && \
    echo "Etc/UTC" > /etc/timezone

# System deps for Python, Node, compiling packages, etc.
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      software-properties-common curl gnupg2 xz-utils ca-certificates jq \
      build-essential git sudo unzip && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
      python3.12 python3.12-venv python3-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    cp /root/.local/bin/uv /usr/local/bin/uv && \
    cp /root/.local/bin/uvx /usr/local/bin/uvx

# Replace pip with uv
RUN ln -sf /usr/local/bin/uv /usr/local/bin/pip

# Install latest Node.js LTS
RUN set -eux; \
    LTS_VERSION=$(curl -fsSL https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)][0].version' | sed 's/^v//'); \
    curl -fsSLO "https://nodejs.org/dist/v${LTS_VERSION}/node-v${LTS_VERSION}-linux-x64.tar.xz"; \
    tar -xJf "node-v${LTS_VERSION}-linux-x64.tar.xz" -C /usr/local --strip-components=1 --no-same-owner; \
    rm "node-v${LTS_VERSION}-linux-x64.tar.xz"; \
    ln -sf /usr/local/bin/node /usr/local/bin/nodejs; \
    node -v && npm -v

# Create non-root user 'computron' with sudo (no password)
RUN useradd --create-home --shell /bin/bash computron && \
    passwd -d computron && \
    usermod -aG sudo computron && \
    echo 'computron ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    chown -R computron:computron /home/computron && \
    chmod 700 /home/computron

# Aliases for Python (python â†’ python3.12)
RUN ln -s /usr/bin/python3.12 /usr/local/bin/python

# Switch to non-root user (safer sandbox)
USER computron
WORKDIR /home/computron

# Default shell
SHELL ["/bin/bash", "-c"]

# Startup: show versions (helps debug sandbox env quickly)
CMD echo "Python: $(python --version)" && \
    echo "Pip: $(pip --version)" && \
    echo "Node: $(node -v)" && \
    echo "NPM: $(npm -v)" && \
    bash
